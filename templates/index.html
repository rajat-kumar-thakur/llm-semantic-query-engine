<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Question Answering Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 900px;
      }
      .upload-area {
        border: 2px dashed #ced4da;
        border-radius: 5px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        background-color: white;
      }
      .chat-area {
        margin-top: 20px;
      }
      .message {
        padding: 10px 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        max-width: 80%;
      }
      .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
      }
      .bot-message {
        background-color: #e9ecef;
        margin-right: auto;
      }
      #loadingIndicator {
        display: none;
      }
      #chatHistory {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        background-color: white;
        border-radius: 5px;
        border: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">PDF Question Answering Tool</h1>

      <div class="upload-area">
        <h4>Upload PDF Document</h4>
        <input type="file" id="pdfUpload" class="form-control" accept=".pdf" />
        <p id="uploadStatus" class="mt-2 text-muted"></p>
      </div>

      <div class="chat-area">
        <h4>Ask Questions About the Document</h4>
        <div class="input-group mb-3">
          <input
            type="text"
            id="questionInput"
            class="form-control"
            placeholder="Type your question here..."
          />
          <button
            id="askButton"
            class="btn btn-primary"
            disabled
            onclick="askQuestion()"
          >
            Ask
          </button>
        </div>
        <div id="loadingIndicator" class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="chatHistory"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Handle PDF upload
      document
        .getElementById("pdfUpload")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);

          try {
            document.getElementById("uploadStatus").textContent =
              "Processing PDF...";
            document.getElementById("askButton").disabled = true;

            const response = await fetch("/api/upload", {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              throw new Error(await response.text());
            }

            const result = await response.json();
            document.getElementById("uploadStatus").textContent =
              result.message;
            document.getElementById("askButton").disabled = false;

            // Clear previous chat
            document.getElementById("chatHistory").innerHTML = "";
          } catch (error) {
            document.getElementById("uploadStatus").textContent =
              "Error: " + error.message;
            console.error("Upload error:", error);
          }
        });

      // Handle question asking
      async function askQuestion() {
        const question = document.getElementById("questionInput").value.trim();
        if (!question) return;

        // Add user question to chat
        addMessage(question, "user");
        document.getElementById("questionInput").value = "";
        document.getElementById("loadingIndicator").style.display = "block";

        try {
          const response = await fetch("/api/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `question=${encodeURIComponent(question)}`,
          });

          if (!response.ok) {
            throw new Error(await response.text());
          }

          const result = await response.json();
          addMessage(result.answer, "bot");
        } catch (error) {
          addMessage("Error: " + error.message, "bot");
          console.error("Error:", error);
        } finally {
          document.getElementById("loadingIndicator").style.display = "none";
        }
      }

      // Add message to chat history
      function addMessage(text, sender) {
        const chatHistory = document.getElementById("chatHistory");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}-message`;
        messageDiv.textContent = text;
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      // Allow pressing Enter to ask question
      document
        .getElementById("questionInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            askQuestion();
          }
        });
    </script>
  </body>
</html>
